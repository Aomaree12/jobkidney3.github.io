<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบแฟ้มเก็บผลงาน - หน่วยไตเทียม สถาบันบำราศนราดูร</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Sarabun', sans-serif;
            background: linear-gradient(135deg, #f0fdfa 0%, #ccfbf1 100%);
            min-height: 100vh;
        }
        
        .menu-card {
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.9);
        }
        
        .menu-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        
        .icon-selector {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .color-option {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .color-option:hover {
            transform: scale(1.1);
        }
        
        .selected-color {
            ring: 3px;
            ring-offset: 2px;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-teal-50 to-emerald-100">
    <!-- Header -->
    <div class="bg-white/80 backdrop-blur-md shadow-lg border-b border-teal-200">
        <div class="container mx-auto px-4 py-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <button onclick="openAddModal()" class="bg-gradient-to-r from-teal-500 to-emerald-500 p-3 rounded-xl hover:from-teal-600 hover:to-emerald-600 transition-all duration-300 shadow-lg hover:shadow-xl" title="เพิ่มเมนูใหม่">
                        <i class="fas fa-folder-open text-white text-2xl"></i>
                    </button>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-800">ระบบแฟ้มเก็บผลงาน</h1>
                        <p class="text-sm text-gray-600">หน่วยไตเทียม สถาบันบำราศนราดูร</p>
                        <div class="flex items-center space-x-2 mt-2">
                            <i class="fas fa-shield-alt text-teal-600 animate-pulse"></i>
                            <p class="text-sm font-semibold text-teal-700">2 P Safety Goals (SIMPLE)</p>
                        </div>
                        <div class="flex items-center space-x-2 mt-1">
                            <i class="fas fa-heart text-red-500 animate-bounce"></i>
                            <p class="text-xs text-gray-600">ผู้ป่วยปลอดภัย เราก็ปลอดภัย</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Menu Categories -->
    <div class="container mx-auto px-4 py-8">
        <div id="menuCategories">
            <!-- Categories will be loaded here -->
        </div>
    </div>

    <!-- Development Plan Table -->
    <div class="container mx-auto px-4 py-8">
        <div class="bg-white/80 backdrop-blur-md rounded-2xl shadow-lg border border-teal-200 p-6">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-tasks text-teal-600 text-2xl animate-pulse"></i>
                    <h2 class="text-2xl font-bold text-gray-800">แผนพัฒนาต่อเนื่อง</h2>
                </div>
                <button onclick="openPlanModal()" class="bg-gradient-to-r from-teal-500 to-emerald-500 p-3 rounded-xl hover:from-teal-600 hover:to-emerald-600 transition-all duration-300 shadow-lg hover:shadow-xl" title="เพิ่มแผนใหม่">
                    <i class="fas fa-plus text-white text-lg"></i>
                </button>
            </div>
            
            <!-- Table -->
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="bg-teal-50 border-b border-teal-200">
                            <th class="text-left py-3 px-4 font-semibold text-gray-700">หัวข้อ</th>
                            <th class="text-left py-3 px-4 font-semibold text-gray-700">ความคืบหน้า</th>
                            <th class="text-left py-3 px-4 font-semibold text-gray-700">หมายเหตุ</th>
                            <th class="text-center py-3 px-4 font-semibold text-gray-700 w-20">จัดการ</th>
                        </tr>
                    </thead>
                    <tbody id="planTableBody">
                        <!-- Plan rows will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Add Menu Modal -->
    <div id="addModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h2 class="text-xl font-bold text-gray-800">เพิ่มเมนูใหม่</h2>
                    <button onclick="closeAddModal()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            
            <div class="p-6 space-y-6">
                <!-- Menu Name -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ชื่อเมนู</label>
                    <input type="text" id="menuName" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-teal-500 focus:border-transparent" placeholder="กรอกชื่อเมนู">
                </div>

                <!-- Link -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ลิงค์</label>
                    <input type="url" id="menuLink" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-teal-500 focus:border-transparent" placeholder="https://example.com">
                </div>

                <!-- Work Type -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ประเภทงาน</label>
                    <select id="workType" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                        <option value="แนะนำหน่วยไตเทียม และแผนพัฒนา">แนะนำหน่วยไตเทียม และแผนพัฒนา</option>
                        <option value="ระบบคุณภาพและความปลอดภัย">ระบบคุณภาพและความปลอดภัย</option>
                        <option value="KPI และ Productivity">KPI และ Productivity</option>
                        <option value="ข้อมูลคลินิกและผลทางการแพทย์">ข้อมูลคลินิกและผลทางการแพทย์</option>
                        <option value="แนวปฏิบัติ">แนวปฏิบัติ</option>
                        <option value="ผลงาน CQIและนวัตกรรม">ผลงาน CQIและนวัตกรรม</option>
                        <option value="ผลงานวิจัย">ผลงานวิจัย</option>
                        <option value="บทความวิชาการ">บทความวิชาการ</option>
                        <option value="อื่นๆ">อื่นๆ</option>
                    </select>
                </div>

                <!-- Icon Selection -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">เลือกไอคอน</label>
                    <div class="border border-gray-300 rounded-xl p-4">
                        <div class="mb-3">
                            <div class="flex items-center justify-center w-16 h-16 bg-teal-100 rounded-xl mx-auto">
                                <i id="selectedIcon" class="fas fa-stethoscope text-2xl text-teal-600"></i>
                            </div>
                        </div>
                        <div class="icon-selector grid grid-cols-10 gap-2">
                            <!-- Medical Icons -->
                        </div>
                    </div>
                </div>

                <!-- Color Selection -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">เลือกสี</label>
                    <div class="grid grid-cols-10 gap-3" id="colorSelector">
                        <!-- Colors will be populated here -->
                    </div>
                </div>

                <!-- Buttons -->
                <div class="flex space-x-4 pt-4">
                    <button onclick="closeAddModal()" class="flex-1 px-6 py-3 border border-gray-300 text-gray-700 rounded-xl hover:bg-gray-50 transition-colors">
                        ยกเลิก
                    </button>
                    <button onclick="saveMenu()" class="flex-1 px-6 py-3 bg-gradient-to-r from-teal-500 to-emerald-500 text-white rounded-xl hover:from-teal-600 hover:to-emerald-600 transition-all">
                        บันทึก
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Plan Modal -->
    <div id="planModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h2 class="text-xl font-bold text-gray-800" id="planModalTitle">เพิ่มแผนพัฒนาใหม่</h2>
                    <button onclick="closePlanModal()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            
            <div class="p-6 space-y-6">
                <!-- Plan Title -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">หัวข้อ</label>
                    <input type="text" id="planTitle" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-teal-500 focus:border-transparent" placeholder="กรอกหัวข้อแผนพัฒนา">
                </div>

                <!-- Progress -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ความคืบหน้า (%)</label>
                    <input type="number" id="planProgress" min="0" max="100" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-teal-500 focus:border-transparent" placeholder="0-100">
                </div>

                <!-- Notes -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">หมายเหตุ</label>
                    <textarea id="planNotes" rows="4" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-teal-500 focus:border-transparent" placeholder="กรอกหมายเหตุ (ถ้ามี)"></textarea>
                </div>

                <!-- Buttons -->
                <div class="flex space-x-4 pt-4">
                    <button onclick="closePlanModal()" class="flex-1 px-6 py-3 border border-gray-300 text-gray-700 rounded-xl hover:bg-gray-50 transition-colors">
                        ยกเลิก
                    </button>
                    <button onclick="savePlan()" class="flex-1 px-6 py-3 bg-gradient-to-r from-teal-500 to-emerald-500 text-white rounded-xl hover:from-teal-600 hover:to-emerald-600 transition-all" id="planSaveBtn">
                        บันทึก
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Menu Modal -->
    <div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h2 class="text-xl font-bold text-gray-800">แก้ไขเมนู</h2>
                    <button onclick="closeEditModal()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            
            <div class="p-6 space-y-6">
                <!-- Menu Name -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ชื่อเมนู</label>
                    <input type="text" id="editMenuName" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-teal-500 focus:border-transparent" placeholder="กรอกชื่อเมนู">
                </div>

                <!-- Link -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ลิงค์</label>
                    <input type="url" id="editMenuLink" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-teal-500 focus:border-transparent" placeholder="https://example.com">
                </div>

                <!-- Work Type -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ประเภทงาน</label>
                    <select id="editWorkType" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                        <option value="แนะนำหน่วยไตเทียม และแผนพัฒนา">แนะนำหน่วยไตเทียม และแผนพัฒนา</option>
                        <option value="ระบบคุณภาพและความปลอดภัย">ระบบคุณภาพและความปลอดภัย</option>
                        <option value="KPI และ Productivity">KPI และ Productivity</option>
                        <option value="ข้อมูลคลินิกและผลทางการแพทย์">ข้อมูลคลินิกและผลทางการแพทย์</option>
                        <option value="แนวปฏิบัติ">แนวปฏิบัติ</option>
                        <option value="ผลงาน CQIและนวัตกรรม">ผลงาน CQIและนวัตกรรม</option>
                        <option value="ผลงานวิจัย">ผลงานวิจัย</option>
                        <option value="บทความวิชาการ">บทความวิชาการ</option>
                        <option value="อื่นๆ">อื่นๆ</option>
                    </select>
                </div>

                <!-- Icon Selection -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">เลือกไอคอน</label>
                    <div class="border border-gray-300 rounded-xl p-4">
                        <div class="mb-3">
                            <div class="flex items-center justify-center w-16 h-16 bg-teal-100 rounded-xl mx-auto">
                                <i id="editSelectedIcon" class="fas fa-stethoscope text-2xl text-teal-600"></i>
                            </div>
                        </div>
                        <div class="edit-icon-selector grid grid-cols-10 gap-2">
                            <!-- Medical Icons -->
                        </div>
                    </div>
                </div>

                <!-- Color Selection -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">เลือกสี</label>
                    <div class="grid grid-cols-10 gap-3" id="editColorSelector">
                        <!-- Colors will be populated here -->
                    </div>
                </div>

                <!-- Buttons -->
                <div class="flex space-x-4 pt-4">
                    <button onclick="deleteMenu()" class="px-6 py-3 bg-red-500 text-white rounded-xl hover:bg-red-600 transition-colors">
                        <i class="fas fa-trash mr-2"></i>ลบ
                    </button>
                    <button onclick="closeEditModal()" class="flex-1 px-6 py-3 border border-gray-300 text-gray-700 rounded-xl hover:bg-gray-50 transition-colors">
                        ยกเลิก
                    </button>
                    <button onclick="updateMenu()" class="flex-1 px-6 py-3 bg-gradient-to-r from-teal-500 to-emerald-500 text-white rounded-xl hover:from-teal-600 hover:to-emerald-600 transition-all">
                        อัพเดท
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx9Zaiu01yY2HdcmQvUgygoRQbCO_q9CTcIG2Iyviqsb03CKrrw16hlyse9GGEVYzqo/exec';
        const PLAN_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzRKwlhac2TC99pdwx1a0MoBk_iouZ9wJeGVtIt-CAJiEFFSk3Bu-0IFcpPredZC2827A/exec';
        
        // Medical Icons (50 icons)
        const medicalIcons = [
            'fa-stethoscope', 'fa-heartbeat', 'fa-user-md', 'fa-hospital', 'fa-ambulance',
            'fa-pills', 'fa-syringe', 'fa-thermometer', 'fa-band-aid', 'fa-x-ray',
            'fa-dna', 'fa-microscope', 'fa-lungs', 'fa-brain', 'fa-tooth',
            'fa-eye', 'fa-hand-holding-heart', 'fa-wheelchair', 'fa-bed', 'fa-clipboard-list',
            'fa-chart-line', 'fa-calendar-check', 'fa-file-medical', 'fa-notes-medical', 'fa-prescription-bottle',
            'fa-first-aid', 'fa-heart', 'fa-kidneys', 'fa-bone', 'fa-virus',
            'fa-shield-virus', 'fa-mask', 'fa-hand-sparkles', 'fa-pump-medical', 'fa-weight-scale',
            'fa-smoking-ban', 'fa-running', 'fa-apple-alt', 'fa-leaf', 'fa-water',
            'fa-sun', 'fa-moon', 'fa-clock', 'fa-bell', 'fa-phone',
            'fa-envelope', 'fa-home', 'fa-user', 'fa-users', 'fa-cog'
        ];

        // Colors (20 colors)
        const colors = [
            '#14b8a6', '#06b6d4', '#3b82f6', '#6366f1', '#8b5cf6',
            '#a855f7', '#d946ef', '#ec4899', '#f43f5e', '#ef4444',
            '#f97316', '#f59e0b', '#eab308', '#84cc16', '#22c55e',
            '#10b981', '#059669', '#0d9488', '#0891b2', '#0284c7'
        ];

        let selectedIcon = 'fa-stethoscope';
        let selectedColor = '#14b8a6';
        let editSelectedIcon = 'fa-stethoscope';
        let editSelectedColor = '#14b8a6';
        let currentEditRowIndex = null;
        let currentEditPlanIndex = null;
        let isEditingPlan = false;

        // Work type categories with icons
        const workTypes = [
            'แนะนำหน่วยไตเทียม และแผนพัฒนา',
            'ระบบคุณภาพและความปลอดภัย',
            'KPI และ Productivity',
            'ข้อมูลคลินิกและผลทางการแพทย์',
            'แนวปฏิบัติ',
            'ผลงาน CQIและนวัตกรรม',
            'ผลงานวิจัย',
            'บทความวิชาการ',
            'อื่นๆ'
        ];

        // Category icons with animations
        const categoryIcons = {
            'แนะนำหน่วยไตเทียม และแผนพัฒนา': 'fas fa-hospital animate-pulse',
            'ระบบคุณภาพและความปลอดภัย': 'fas fa-shield-alt animate-bounce',
            'KPI และ Productivity': 'fas fa-chart-line animate-pulse',
            'ข้อมูลคลินิกและผลทางการแพทย์': 'fas fa-stethoscope animate-bounce',
            'แนวปฏิบัติ': 'fas fa-clipboard-list animate-pulse',
            'ผลงาน CQIและนวัตกรรม': 'fas fa-lightbulb animate-bounce',
            'ผลงานวิจัย': 'fas fa-microscope animate-pulse',
            'บทความวิชาการ': 'fas fa-book-open animate-bounce',
            'อื่นๆ': 'fas fa-folder animate-pulse'
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadMenus();
            loadPlans();
            initializeIconSelector();
            initializeColorSelector();
            initializeEditIconSelector();
            initializeEditColorSelector();
        });

        // Load menus from Google Sheets
        function loadMenus() {
            const script = document.createElement('script');
            script.src = `${SCRIPT_URL}?callback=handleMenuData&action=getData`;
            document.head.appendChild(script);
        }

        // Handle menu data callback
        function handleMenuData(data) {
            const menuCategories = document.getElementById('menuCategories');
            menuCategories.innerHTML = '';

            console.log('Received data:', data); // Debug log

            if (data && Array.isArray(data) && data.length > 0) {
                // Group menus by work type
                const groupedMenus = {};
                
                data.forEach((menu, index) => {
                    console.log('Processing menu:', menu); // Debug log
                    console.log('Menu keys:', Object.keys(menu)); // Debug log to see all keys
                    
                    if (menu.menuName && menu.link) {
                        // Use the workType field directly from the response
                        let workType = menu.workType;
                        
                        console.log('Work type found:', workType); // Debug log
                        
                        // If no work type is specified or empty, put in "อื่นๆ"
                        if (!workType || workType.trim() === '') {
                            workType = 'อื่นๆ';
                        }
                        
                        if (!groupedMenus[workType]) {
                            groupedMenus[workType] = [];
                        }
                        groupedMenus[workType].push({
                            'Menu Name': menu.menuName,
                            'Link': menu.link,
                            'icon': menu.icon,
                            'สี': menu.color,
                            'ประเภทงาน': menu.workType,
                            rowIndex: index + 2
                        });
                    }
                });

                console.log('Grouped menus:', groupedMenus); // Debug log

                // Create category sections in the order defined in workTypes array
                workTypes.forEach(workType => {
                    if (groupedMenus[workType] && groupedMenus[workType].length > 0) {
                        const categorySection = createCategorySection(workType, groupedMenus[workType]);
                        menuCategories.appendChild(categorySection);
                    }
                });

                // If no categories were created, show all menus under "อื่นๆ"
                if (menuCategories.children.length === 0) {
                    console.log('No categories found, showing all under อื่นๆ');
                    const allMenus = data.filter(menu => menu.menuName && menu.link)
                                        .map((menu, index) => ({
                                            'Menu Name': menu.menuName,
                                            'Link': menu.link,
                                            'icon': menu.icon,
                                            'สี': menu.color,
                                            'ประเภทงาน': 'อื่นๆ',
                                            rowIndex: index + 2
                                        }));
                    if (allMenus.length > 0) {
                        const categorySection = createCategorySection('อื่นๆ', allMenus);
                        menuCategories.appendChild(categorySection);
                    }
                }
            } else if (data && !data.success && data.message) {
                // Handle error response
                console.error('Error loading data:', data.message);
                Swal.fire({
                    icon: 'error',
                    title: 'เกิดข้อผิดพลาด',
                    text: 'ไม่สามารถโหลดข้อมูลได้: ' + data.message,
                    confirmButtonColor: '#14b8a6'
                });
            } else {
                console.log('No data received or empty data');
                menuCategories.innerHTML = '<div class="text-center text-gray-500 py-8">ไม่มีข้อมูลเมนู</div>';
            }
        }

        // Create category section
        function createCategorySection(workType, menus) {
            const section = document.createElement('div');
            section.className = 'mb-8';
            
            const iconClass = categoryIcons[workType] || 'fas fa-folder animate-pulse';
            section.innerHTML = `
                <div class="mb-4">
                    <div class="flex items-center space-x-3">
                        <i class="${iconClass} text-teal-600 text-xl"></i>
                        <h2 class="text-xl font-bold text-gray-800 border-b-2 border-teal-500 pb-2">${workType}</h2>
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6" id="category-${workType.replace(/\s+/g, '-')}">
                </div>
            `;
            
            const grid = section.querySelector(`#category-${workType.replace(/\s+/g, '-')}`);
            menus.forEach(menu => {
                const menuCard = createMenuCard(menu, menu.rowIndex);
                grid.appendChild(menuCard);
            });
            
            return section;
        }

        // Create menu card
        function createMenuCard(menu, rowIndex) {
            const card = document.createElement('div');
            card.className = 'menu-card bg-white rounded-2xl p-6 shadow-lg hover:shadow-xl transition-all duration-300 cursor-pointer border border-teal-100 relative';
            
            const iconColor = menu['สี'] || '#14b8a6';
            const iconClass = menu['icon'] || 'fa-stethoscope';
            
            card.innerHTML = `
                <div class="absolute top-2 right-2">
                    <button onclick="event.stopPropagation(); editMenu(${rowIndex}, '${menu['Menu Name']}', '${menu['Link']}', '${iconClass}', '${iconColor}', '${menu['ประเภทงาน'] || 'อื่นๆ'}')" class="w-8 h-8 bg-gray-100 hover:bg-gray-200 rounded-full flex items-center justify-center transition-colors" title="แก้ไข">
                        <i class="fas fa-edit text-gray-600 text-sm"></i>
                    </button>
                </div>
                <div class="text-center" onclick="event.stopPropagation(); openLink('${menu['Link']}')">
                    <div class="w-16 h-16 mx-auto mb-4 rounded-xl flex items-center justify-center" style="background-color: ${iconColor}20;">
                        <i class="fas ${iconClass} text-3xl" style="color: ${iconColor};"></i>
                    </div>
                    <h3 class="font-semibold text-gray-800 text-sm mb-2">${menu['Menu Name']}</h3>
                </div>
            `;
            
            return card;
        }

        // Open link - optimized for LINE application
        function openLink(url) {
            // Check if running in LINE app
            const isLineApp = /Line/i.test(navigator.userAgent);
            
            if (isLineApp) {
                // For LINE app, use location.href for better compatibility
                window.location.href = url;
            } else {
                // For regular browsers, use window.open
                window.open(url, '_blank');
            }
        }

        // Initialize icon selector
        function initializeIconSelector() {
            const iconSelector = document.querySelector('.icon-selector');
            medicalIcons.forEach(icon => {
                const iconDiv = document.createElement('div');
                iconDiv.className = 'w-10 h-10 flex items-center justify-center bg-gray-100 rounded-lg cursor-pointer hover:bg-teal-100 transition-colors';
                iconDiv.innerHTML = `<i class="fas ${icon} text-gray-600"></i>`;
                iconDiv.onclick = () => selectIcon(icon, iconDiv);
                iconSelector.appendChild(iconDiv);
            });
        }

        // Select icon
        function selectIcon(icon, element) {
            // Remove previous selection
            document.querySelectorAll('.icon-selector > div').forEach(div => {
                div.classList.remove('bg-teal-200', 'ring-2', 'ring-teal-500');
                div.classList.add('bg-gray-100');
            });
            
            // Add selection to clicked element
            element.classList.remove('bg-gray-100');
            element.classList.add('bg-teal-200', 'ring-2', 'ring-teal-500');
            
            // Update selected icon
            selectedIcon = icon;
            document.getElementById('selectedIcon').className = `fas ${icon} text-2xl text-teal-600`;
        }

        // Initialize color selector
        function initializeColorSelector() {
            const colorSelector = document.getElementById('colorSelector');
            colors.forEach((color, index) => {
                const colorDiv = document.createElement('div');
                colorDiv.className = `color-option ${index === 0 ? 'selected-color ring-teal-500' : ''}`;
                colorDiv.style.backgroundColor = color;
                colorDiv.onclick = () => selectColor(color, colorDiv);
                colorSelector.appendChild(colorDiv);
            });
        }

        // Select color
        function selectColor(color, element) {
            // Remove previous selection
            document.querySelectorAll('.color-option').forEach(div => {
                div.classList.remove('selected-color', 'ring-teal-500');
            });
            
            // Add selection to clicked element
            element.classList.add('selected-color', 'ring-teal-500');
            selectedColor = color;
        }

        // Modal functions
        function openAddModal() {
            document.getElementById('addModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeAddModal() {
            document.getElementById('addModal').classList.add('hidden');
            document.body.style.overflow = 'auto';
            
            // Reset form
            document.getElementById('menuName').value = '';
            document.getElementById('menuLink').value = '';
            selectedIcon = 'fa-stethoscope';
            selectedColor = '#14b8a6';
            
            // Reset selections
            document.getElementById('selectedIcon').className = 'fas fa-stethoscope text-2xl text-teal-600';
            document.querySelectorAll('.icon-selector > div').forEach(div => {
                div.classList.remove('bg-teal-200', 'ring-2', 'ring-teal-500');
                div.classList.add('bg-gray-100');
            });
            document.querySelectorAll('.color-option').forEach((div, index) => {
                div.classList.remove('selected-color', 'ring-teal-500');
                if (index === 0) div.classList.add('selected-color', 'ring-teal-500');
            });
        }

        // Save menu
        function saveMenu() {
            const menuName = document.getElementById('menuName').value.trim();
            const menuLink = document.getElementById('menuLink').value.trim();
            const workType = document.getElementById('workType').value;

            if (!menuName || !menuLink) {
                Swal.fire({
                    icon: 'warning',
                    title: 'กรุณากรอกข้อมูลให้ครบถ้วน',
                    text: 'ชื่อเมนูและลิงค์เป็นข้อมูลที่จำเป็น',
                    confirmButtonColor: '#14b8a6'
                });
                return;
            }

            // Show loading
            Swal.fire({
                title: 'กำลังบันทึกข้อมูล...',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            // Prepare data
            const menuData = {
                action: 'addData',
                menuName: menuName,
                link: menuLink,
                workType: workType,
                icon: selectedIcon,
                color: selectedColor
            };

            // Send data using JSONP
            const script = document.createElement('script');
            const callbackName = 'saveCallback_' + Date.now();
            
            window[callbackName] = function(response) {
                document.head.removeChild(script);
                delete window[callbackName];
                
                if (response.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'บันทึกสำเร็จ!',
                        text: 'เมนูใหม่ถูกเพิ่มเรียบร้อยแล้ว',
                        confirmButtonColor: '#14b8a6'
                    }).then(() => {
                        closeAddModal();
                        loadMenus();
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'เกิดข้อผิดพลาด',
                        text: response.message || 'ไม่สามารถบันทึกข้อมูลได้',
                        confirmButtonColor: '#14b8a6'
                    });
                }
            };

            const params = new URLSearchParams(menuData).toString();
            script.src = `${SCRIPT_URL}?${params}&callback=${callbackName}`;
            document.head.appendChild(script);
        }

        // Edit menu functions
        function editMenu(rowIndex, menuName, link, icon, color, workType) {
            currentEditRowIndex = rowIndex;
            
            // Populate form
            document.getElementById('editMenuName').value = menuName;
            document.getElementById('editMenuLink').value = link;
            document.getElementById('editWorkType').value = workType || 'อื่นๆ';
            editSelectedIcon = icon;
            editSelectedColor = color;
            
            // Update preview
            document.getElementById('editSelectedIcon').className = `fas ${icon} text-2xl text-teal-600`;
            
            // Update selections
            updateEditIconSelection(icon);
            updateEditColorSelection(color);
            
            // Show modal
            document.getElementById('editModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.add('hidden');
            document.body.style.overflow = 'auto';
            currentEditRowIndex = null;
        }

        function updateMenu() {
            const menuName = document.getElementById('editMenuName').value.trim();
            const menuLink = document.getElementById('editMenuLink').value.trim();
            const workType = document.getElementById('editWorkType').value;

            if (!menuName || !menuLink) {
                Swal.fire({
                    icon: 'warning',
                    title: 'กรุณากรอกข้อมูลให้ครบถ้วน',
                    text: 'ชื่อเมนูและลิงค์เป็นข้อมูลที่จำเป็น',
                    confirmButtonColor: '#14b8a6'
                });
                return;
            }

            // Show loading
            Swal.fire({
                title: 'กำลังอัพเดทข้อมูล...',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            // Prepare data
            const menuData = {
                action: 'updateData',
                index: currentEditRowIndex,
                menuName: menuName,
                link: menuLink,
                workType: workType,
                icon: editSelectedIcon,
                color: editSelectedColor
            };

            // Send data using JSONP
            const script = document.createElement('script');
            const callbackName = 'updateCallback_' + Date.now();
            
            window[callbackName] = function(response) {
                document.head.removeChild(script);
                delete window[callbackName];
                
                if (response.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'อัพเดทสำเร็จ!',
                        text: 'ข้อมูลเมนูถูกอัพเดทเรียบร้อยแล้ว',
                        confirmButtonColor: '#14b8a6'
                    }).then(() => {
                        closeEditModal();
                        loadMenus();
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'เกิดข้อผิดพลาด',
                        text: response.message || 'ไม่สามารถอัพเดทข้อมูลได้',
                        confirmButtonColor: '#14b8a6'
                    });
                }
            };

            const params = new URLSearchParams(menuData).toString();
            script.src = `${SCRIPT_URL}?${params}&callback=${callbackName}`;
            document.head.appendChild(script);
        }

        function deleteMenu() {
            Swal.fire({
                title: 'ยืนยันการลบ',
                text: 'คุณต้องการลบเมนูนี้หรือไม่?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                cancelButtonColor: '#6b7280',
                confirmButtonText: 'ลบ',
                cancelButtonText: 'ยกเลิก'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Show loading
                    Swal.fire({
                        title: 'กำลังลบข้อมูล...',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });

                    // Prepare data
                    const deleteData = {
                        action: 'deleteData',
                        index: currentEditRowIndex
                    };

                    // Send data using JSONP
                    const script = document.createElement('script');
                    const callbackName = 'deleteCallback_' + Date.now();
                    
                    window[callbackName] = function(response) {
                        document.head.removeChild(script);
                        delete window[callbackName];
                        
                        if (response.success) {
                            Swal.fire({
                                icon: 'success',
                                title: 'ลบสำเร็จ!',
                                text: 'เมนูถูกลบเรียบร้อยแล้ว',
                                confirmButtonColor: '#14b8a6'
                            }).then(() => {
                                closeEditModal();
                                loadMenus();
                            });
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'เกิดข้อผิดพลาด',
                                text: response.message || 'ไม่สามารถลบข้อมูลได้',
                                confirmButtonColor: '#14b8a6'
                            });
                        }
                    };

                    const params = new URLSearchParams(deleteData).toString();
                    script.src = `${SCRIPT_URL}?${params}&callback=${callbackName}`;
                    document.head.appendChild(script);
                }
            });
        }

        // Initialize edit icon selector
        function initializeEditIconSelector() {
            const iconSelector = document.querySelector('.edit-icon-selector');
            medicalIcons.forEach(icon => {
                const iconDiv = document.createElement('div');
                iconDiv.className = 'w-10 h-10 flex items-center justify-center bg-gray-100 rounded-lg cursor-pointer hover:bg-teal-100 transition-colors';
                iconDiv.innerHTML = `<i class="fas ${icon} text-gray-600"></i>`;
                iconDiv.onclick = () => selectEditIcon(icon, iconDiv);
                iconSelector.appendChild(iconDiv);
            });
        }

        // Select edit icon
        function selectEditIcon(icon, element) {
            // Remove previous selection
            document.querySelectorAll('.edit-icon-selector > div').forEach(div => {
                div.classList.remove('bg-teal-200', 'ring-2', 'ring-teal-500');
                div.classList.add('bg-gray-100');
            });
            
            // Add selection to clicked element
            element.classList.remove('bg-gray-100');
            element.classList.add('bg-teal-200', 'ring-2', 'ring-teal-500');
            
            // Update selected icon
            editSelectedIcon = icon;
            document.getElementById('editSelectedIcon').className = `fas ${icon} text-2xl text-teal-600`;
        }

        // Initialize edit color selector
        function initializeEditColorSelector() {
            const colorSelector = document.getElementById('editColorSelector');
            colors.forEach((color, index) => {
                const colorDiv = document.createElement('div');
                colorDiv.className = `color-option ${index === 0 ? 'selected-color ring-teal-500' : ''}`;
                colorDiv.style.backgroundColor = color;
                colorDiv.onclick = () => selectEditColor(color, colorDiv);
                colorSelector.appendChild(colorDiv);
            });
        }

        // Select edit color
        function selectEditColor(color, element) {
            // Remove previous selection
            document.querySelectorAll('#editColorSelector .color-option').forEach(div => {
                div.classList.remove('selected-color', 'ring-teal-500');
            });
            
            // Add selection to clicked element
            element.classList.add('selected-color', 'ring-teal-500');
            editSelectedColor = color;
        }

        // Update edit selections
        function updateEditIconSelection(icon) {
            document.querySelectorAll('.edit-icon-selector > div').forEach((div, index) => {
                div.classList.remove('bg-teal-200', 'ring-2', 'ring-teal-500');
                div.classList.add('bg-gray-100');
                
                if (medicalIcons[index] === icon) {
                    div.classList.remove('bg-gray-100');
                    div.classList.add('bg-teal-200', 'ring-2', 'ring-teal-500');
                }
            });
        }

        function updateEditColorSelection(color) {
            document.querySelectorAll('#editColorSelector .color-option').forEach((div, index) => {
                div.classList.remove('selected-color', 'ring-teal-500');
                
                if (colors[index] === color) {
                    div.classList.add('selected-color', 'ring-teal-500');
                }
            });
        }

        // Plan Management Functions
        function loadPlans() {
            const script = document.createElement('script');
            script.src = `${PLAN_SCRIPT_URL}?callback=handlePlanData&action=getData`;
            document.head.appendChild(script);
        }

        function handlePlanData(data) {
            const planTableBody = document.getElementById('planTableBody');
            planTableBody.innerHTML = '';

            if (data && Array.isArray(data) && data.length > 0) {
                data.forEach((plan, index) => {
                    if (plan.title) {
                        const row = createPlanRow(plan, index + 2);
                        planTableBody.appendChild(row);
                    }
                });
            } else {
                planTableBody.innerHTML = '<tr><td colspan="4" class="text-center py-8 text-gray-500">ไม่มีข้อมูลแผนพัฒนา</td></tr>';
            }
        }

        function createPlanRow(plan, rowIndex) {
            const row = document.createElement('tr');
            row.className = 'border-b border-gray-200 hover:bg-gray-50';
            
            const progress = plan.progress || 0;
            const progressColor = progress < 30 ? 'bg-red-500' : progress < 70 ? 'bg-yellow-500' : 'bg-green-500';
            
            row.innerHTML = `
                <td class="py-3 px-4 text-gray-800">${plan.title}</td>
                <td class="py-3 px-4">
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="${progressColor} h-2 rounded-full transition-all duration-300" style="width: ${progress}%"></div>
                    </div>
                    <span class="text-xs text-gray-600 mt-1">${progress}%</span>
                </td>
                <td class="py-3 px-4 text-gray-600 text-sm">${plan.notes || '-'}</td>
                <td class="py-3 px-4 text-center">
                    <div class="relative inline-block">
                        <button onclick="togglePlanActions(${rowIndex})" class="w-8 h-8 bg-gray-100 hover:bg-gray-200 rounded-full flex items-center justify-center transition-colors" title="จัดการ">
                            <i class="fas fa-ellipsis-v text-gray-600"></i>
                        </button>
                        <div id="planActions-${rowIndex}" class="hidden absolute right-0 mt-2 w-32 bg-white rounded-lg shadow-lg border z-10">
                            <button onclick="viewPlan(${rowIndex}, '${plan.title}', ${progress}, '${plan.notes || ''}')" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-t-lg">
                                <i class="fas fa-eye mr-2"></i>ดู
                            </button>
                            <button onclick="editPlan(${rowIndex}, '${plan.title}', ${progress}, '${plan.notes || ''}')" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                <i class="fas fa-edit mr-2"></i>แก้ไข
                            </button>
                            <button onclick="deletePlan(${rowIndex})" class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 rounded-b-lg">
                                <i class="fas fa-trash mr-2"></i>ลบ
                            </button>
                        </div>
                    </div>
                </td>
            `;
            
            return row;
        }

        function togglePlanActions(rowIndex) {
            const actionsDiv = document.getElementById(`planActions-${rowIndex}`);
            const allActions = document.querySelectorAll('[id^="planActions-"]');
            
            // Hide all other action menus
            allActions.forEach(div => {
                if (div.id !== `planActions-${rowIndex}`) {
                    div.classList.add('hidden');
                }
            });
            
            // Toggle current menu
            actionsDiv.classList.toggle('hidden');
        }

        function openPlanModal() {
            isEditingPlan = false;
            document.getElementById('planModalTitle').textContent = 'เพิ่มแผนพัฒนาใหม่';
            document.getElementById('planSaveBtn').textContent = 'บันทึก';
            document.getElementById('planTitle').value = '';
            document.getElementById('planProgress').value = '';
            document.getElementById('planNotes').value = '';
            document.getElementById('planModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closePlanModal() {
            document.getElementById('planModal').classList.add('hidden');
            document.body.style.overflow = 'auto';
            currentEditPlanIndex = null;
            isEditingPlan = false;
        }

        function editPlan(rowIndex, title, progress, notes) {
            isEditingPlan = true;
            currentEditPlanIndex = rowIndex;
            document.getElementById('planModalTitle').textContent = 'แก้ไขแผนพัฒนา';
            document.getElementById('planSaveBtn').textContent = 'อัพเดท';
            document.getElementById('planTitle').value = title;
            document.getElementById('planProgress').value = progress;
            document.getElementById('planNotes').value = notes;
            document.getElementById('planModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            
            // Hide action menu
            document.getElementById(`planActions-${rowIndex}`).classList.add('hidden');
        }

        function viewPlan(rowIndex, title, progress, notes) {
            Swal.fire({
                title: title,
                html: `
                    <div class="text-left space-y-3">
                        <div>
                            <strong>ความคืบหน้า:</strong> ${progress}%
                            <div class="w-full bg-gray-200 rounded-full h-2 mt-1">
                                <div class="${progress < 30 ? 'bg-red-500' : progress < 70 ? 'bg-yellow-500' : 'bg-green-500'} h-2 rounded-full" style="width: ${progress}%"></div>
                            </div>
                        </div>
                        <div>
                            <strong>หมายเหตุ:</strong><br>
                            ${notes || 'ไม่มีหมายเหตุ'}
                        </div>
                    </div>
                `,
                confirmButtonColor: '#14b8a6',
                confirmButtonText: 'ปิด'
            });
            
            // Hide action menu
            document.getElementById(`planActions-${rowIndex}`).classList.add('hidden');
        }

        function savePlan() {
            const title = document.getElementById('planTitle').value.trim();
            const progress = parseInt(document.getElementById('planProgress').value) || 0;
            const notes = document.getElementById('planNotes').value.trim();

            if (!title) {
                Swal.fire({
                    icon: 'warning',
                    title: 'กรุณากรอกหัวข้อ',
                    text: 'หัวข้อเป็นข้อมูลที่จำเป็น',
                    confirmButtonColor: '#14b8a6'
                });
                return;
            }

            if (progress < 0 || progress > 100) {
                Swal.fire({
                    icon: 'warning',
                    title: 'ความคืบหน้าไม่ถูกต้อง',
                    text: 'กรุณากรอกความคืบหน้าระหว่าง 0-100',
                    confirmButtonColor: '#14b8a6'
                });
                return;
            }

            // Show loading
            Swal.fire({
                title: isEditingPlan ? 'กำลังอัพเดทข้อมูล...' : 'กำลังบันทึกข้อมูล...',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            const planData = {
                action: isEditingPlan ? 'updateData' : 'addData',
                title: title,
                progress: progress,
                notes: notes
            };

            if (isEditingPlan) {
                planData.index = currentEditPlanIndex;
            }

            // Send data using JSONP
            const script = document.createElement('script');
            const callbackName = 'planCallback_' + Date.now();
            
            window[callbackName] = function(response) {
                document.head.removeChild(script);
                delete window[callbackName];
                
                if (response.success) {
                    Swal.fire({
                        icon: 'success',
                        title: isEditingPlan ? 'อัพเดทสำเร็จ!' : 'บันทึกสำเร็จ!',
                        text: isEditingPlan ? 'แผนพัฒนาถูกอัพเดทเรียบร้อยแล้ว' : 'แผนพัฒนาใหม่ถูกเพิ่มเรียบร้อยแล้ว',
                        confirmButtonColor: '#14b8a6'
                    }).then(() => {
                        closePlanModal();
                        loadPlans();
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'เกิดข้อผิดพลาด',
                        text: response.message || 'ไม่สามารถบันทึกข้อมูลได้',
                        confirmButtonColor: '#14b8a6'
                    });
                }
            };

            const params = new URLSearchParams(planData).toString();
            script.src = `${PLAN_SCRIPT_URL}?${params}&callback=${callbackName}`;
            document.head.appendChild(script);
        }

        function deletePlan(rowIndex) {
            Swal.fire({
                title: 'ยืนยันการลบ',
                text: 'คุณต้องการลบแผนพัฒนานี้หรือไม่?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                cancelButtonColor: '#6b7280',
                confirmButtonText: 'ลบ',
                cancelButtonText: 'ยกเลิก'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Show loading
                    Swal.fire({
                        title: 'กำลังลบข้อมูล...',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });

                    const deleteData = {
                        action: 'deleteData',
                        index: rowIndex
                    };

                    const script = document.createElement('script');
                    const callbackName = 'deletePlanCallback_' + Date.now();
                    
                    window[callbackName] = function(response) {
                        document.head.removeChild(script);
                        delete window[callbackName];
                        
                        if (response.success) {
                            Swal.fire({
                                icon: 'success',
                                title: 'ลบสำเร็จ!',
                                text: 'แผนพัฒนาถูกลบเรียบร้อยแล้ว',
                                confirmButtonColor: '#14b8a6'
                            }).then(() => {
                                loadPlans();
                            });
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'เกิดข้อผิดพลาด',
                                text: response.message || 'ไม่สามารถลบข้อมูลได้',
                                confirmButtonColor: '#14b8a6'
                            });
                        }
                    };

                    const params = new URLSearchParams(deleteData).toString();
                    script.src = `${PLAN_SCRIPT_URL}?${params}&callback=${callbackName}`;
                    document.head.appendChild(script);
                }
            });
            
            // Hide action menu
            document.getElementById(`planActions-${rowIndex}`).classList.add('hidden');
        }

        // Close action menus when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('[id^="planActions-"]') && !e.target.closest('button[onclick*="togglePlanActions"]')) {
                document.querySelectorAll('[id^="planActions-"]').forEach(div => {
                    div.classList.add('hidden');
                });
            }
        });

        // Handle errors
        window.addEventListener('error', function(e) {
            if (e.target.tagName === 'SCRIPT') {
                Swal.fire({
                    icon: 'error',
                    title: 'เกิดข้อผิดพลาด',
                    text: 'ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์ได้',
                    confirmButtonColor: '#14b8a6'
                });
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'961fbc4eb41033b6',t:'MTc1Mjk4NTk1NS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
